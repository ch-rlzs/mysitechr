<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>chrlzs chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <style>
    :root {
      --primary: #00ffcc;
      --primary-transparent: #00ffcc33;
      --background: #0a0a0a;
      --panel: #111;
      --danger: #ff3333;
      --warning: #ffcc00;
    }
    
    body {
      background-color: var(--background);
      color: var(--primary);
      font-family: 'Fira Code', monospace;
      margin: 0;
      padding: 10px;
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 200px;
      background: var(--panel);
      border-right: 1px solid var(--primary-transparent);
      padding: 15px;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .chat-box {
      background: var(--panel);
      border: 1px solid var(--primary-transparent);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 10px var(--primary-transparent);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    .messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      border-bottom: 1px dashed var(--primary-transparent);
    }
    
    .message {
      margin-bottom: 10px;
      word-break: break-word;
      padding: 8px;
      border-radius: 4px;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .username {
      color: #00ffaa;
      font-weight: bold;
    }
    
    .timestamp {
      color: #00ffcc66;
      font-size: 0.8em;
      margin-left: 5px;
    }
    
    input[type="text"], input[type="password"], input[type="number"] {
      width: 100%;
      padding: 10px;
      font-family: 'Fira Code', monospace;
      border: 1px solid var(--primary-transparent);
      background: var(--background);
      color: var(--primary);
      border-radius: 4px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    
    button {
      padding: 8px 12px;
      background: var(--primary);
      color: black;
      font-family: 'Fira Code', monospace;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: black;
    }
    
    .admin-controls {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed var(--primary-transparent);
    }
    
    .typing-indicator {
      margin-bottom: 10px;
      color: #00ffaa;
      min-height: 20px;
    }
    
    .user-list {
      margin-top: 20px;
    }
    
    .user-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: var(--primary);
      color: black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .admin-badge {
      background: var(--danger);
      color: white;
      font-size: 0.7em;
      padding: 2px 5px;
      border-radius: 3px;
      margin-left: 5px;
    }
    
    .message-actions {
      margin-top: 5px;
    }
    
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: auto;
        margin-right: 0;
        margin-bottom: 10px;
        border-right: none;
        border-bottom: 1px solid var(--primary-transparent);
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Online Users</h3>
    <div class="user-list" id="userList"></div>
    
    <div id="adminSidebar" style="display: none; margin-top: 20px;">
      <h3>Admin Channels</h3>
      <button onclick="switchToAdminChat()" class="btn-danger">Admin Chat</button>
      <button onclick="switchToPublicChat()">Public Chat</button>
      
      <h3>Moderation Logs</h3>
      <div id="modLogs"></div>
    </div>
  </div>

  <div class="main-content">
    <div id="loginSection">
      <h2>Enter Chat</h2>
      <input type="text" id="usernameInput" placeholder="Your username" />
      <div id="adminLogin" style="display: none; margin-top: 10px;">
        <input type="password" id="adminPassword" placeholder="Admin password" />
      </div>
      <button onclick="login()">Join</button>
    </div>
    
    <div id="chatSection" style="display: none;">
      <div class="chat-box">
        <div class="messages" id="chatMessages"></div>
        <div class="typing-indicator" id="typingIndicator"></div>
        
        <input type="text" id="messageInput" placeholder="Type your message..." />
        <div style="display: flex; margin-top: 10px;">
          <button onclick="sendMessage()">Send</button>
          <button onclick="logout()" class="btn-danger">Logout</button>
        </div>
      </div>
      
      <div id="adminPanel" class="admin-controls" style="display: none;">
        <h3>Admin Controls</h3>
        <input type="text" id="banInput" placeholder="Username to ban" />
        <input type="number" id="banDuration" placeholder="Hours (0=permanent)" value="24" min="0" />
        <button onclick="banUser()" class="btn-danger">Ban User</button>
        <button onclick="deleteAllMessages()" class="btn-danger">Delete All Messages</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAgFYlZc9PI95uSEC_iejXEZOerZ8ebO44",
      authDomain: "chrlzs-chat-645cf.firebaseapp.com",
      databaseURL: "https://chrlzs-chat-645cf-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "chrlzs-chat-645cf",
      storageBucket: "chrlzs-chat-645cf.appspot.com",
      messagingSenderId: "426878855113",
      appId: "1:426878855113:web:166da584829cffd5106a18",
      measurementId: "G-5XW702X3TQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // App State
    const ADMIN_USERNAME = 'chrlzs';
    const ADMIN_PASSWORD = 'P4ssedHumidPerpendicular27';
    const bannedWords = ['badword1', 'badword2', 'example']; // Add your banned words
    let currentUser = null;
    let isAdmin = false;
    let lastMessageTime = 0;
    let messageCount = 0;
    const messageCooldown = 1000; // 1 second cooldown
    const spamThreshold = 5; // 5 messages in 10 seconds
    let userIP = 'unknown';

    // Database References
    const messagesRef = db.ref('messages');
    const adminChatRef = db.ref('adminChat');
    const usersRef = db.ref('users');
    const bannedUsersRef = db.ref('bannedUsers');
    const ipBansRef = db.ref('ipBans');
    const modLogsRef = db.ref('moderationLogs');
    const reportedMessagesRef = db.ref('reportedMessages');
    const typingRef = db.ref('typing');

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadUserFromStorage();
      setupEventListeners();
      detectIP().then(ip => {
        userIP = ip;
        checkIPBan(ip);
      });
    });

    // Load user from localStorage
    function loadUserFromStorage() {
      const savedUser = localStorage.getItem('chatUser');
      if (savedUser) {
        currentUser = savedUser;
        isAdmin = localStorage.getItem('chatIsAdmin') === 'true';
        startChatSession();
      }
    }

    // Save user to localStorage
    function saveUserToStorage() {
      if (currentUser) {
        localStorage.setItem('chatUser', currentUser);
        localStorage.setItem('chatIsAdmin', isAdmin.toString());
      }
    }

    // Clear user from storage
    function clearUserFromStorage() {
      localStorage.removeItem('chatUser');
      localStorage.removeItem('chatIsAdmin');
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      document.getElementById('messageInput')?.addEventListener('input', () => {
        updateTypingIndicator(true);
        debounceTypingIndicator();
      });
      
      document.getElementById('usernameInput')?.addEventListener('input', (e) => {
        if (e.target.value === ADMIN_USERNAME) {
          document.getElementById('adminLogin').style.display = 'block';
        } else {
          document.getElementById('adminLogin').style.display = 'none';
        }
      });
    }

    // Detect user IP
    function detectIP() {
      return fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => data.ip)
        .catch(() => 'unknown');
    }

    // Check if IP is banned
    function checkIPBan(ip) {
      ipBansRef.once('value').then(snapshot => {
        const bans = snapshot.val() || {};
        if (bans[ip] && bans[ip] > Date.now()) {
          const banTime = new Date(bans[ip]);
          alert(`Your IP is banned until ${banTime.toLocaleString()}`);
          logout();
        }
      });
    }

    // Login function
    function login() {
      const username = document.getElementById('usernameInput').value.trim();
      const password = document.getElementById('adminPassword')?.value;
      
      if (!username) {
        alert("Please enter a username");
        return;
      }
      
      // Check if username is admin
      if (username === ADMIN_USERNAME) {
        if (!password || password !== ADMIN_PASSWORD) {
          alert("Invalid admin password");
          return;
        }
        isAdmin = true;
      }
      
      currentUser = username;
      saveUserToStorage();
      startChatSession();
      
      // Add user to active users
      usersRef.child(username).set({
        online: true,
        lastActive: Date.now(),
        isAdmin: isAdmin,
        ip: userIP
      });
      
      // Remove user when they disconnect
      usersRef.child(username).onDisconnect().remove();
    }

    // Start chat session
    function startChatSession() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('chatSection').style.display = 'block';
      
      if (isAdmin) {
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminSidebar').style.display = 'block';
        loadModLogs();
      }
      
      setupUserList();
      loadMessages();
      setupTypingListener();
      document.getElementById('messageInput').focus();
    }

    // Logout function
    function logout() {
      updateTypingIndicator(false);
      if (currentUser) {
        usersRef.child(currentUser).remove();
      }
      clearUserFromStorage();
      currentUser = null;
      isAdmin = false;
      
      document.getElementById('chatSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('usernameInput').value = '';
      document.getElementById('adminPassword').value = '';
      document.getElementById('usernameInput').focus();
    }

    // Send message with all protections
    function sendMessage() {
      const now = Date.now();
      const text = document.getElementById('messageInput').value.trim();
      
      // Rate limiting
      if (now - lastMessageTime < messageCooldown) {
        alert(`Please wait ${Math.ceil((messageCooldown - (now - lastMessageTime))/1000)} seconds`);
        return;
      }
      
      // Spam detection
      messageCount++;
      if (messageCount >= spamThreshold) {
        setTimeout(() => messageCount--, 10000); // Reset counter after 10 seconds
        if (messageCount >= spamThreshold) {
          alert("Slow down! You're sending too many messages");
          return;
        }
      }
      
      // Check if user is banned
      bannedUsersRef.child(currentUser).once('value').then(snap => {
        const banExpiry = snap.val();
        if (banExpiry && banExpiry > Date.now()) {
          alert(`You're banned until ${new Date(banExpiry).toLocaleString()}`);
          return;
        }
        
        // Word filter
        const filteredText = filterBannedWords(text);
        if (filteredText !== text) {
          alert("Your message contained blocked words and was modified");
        }
        
        const message = {
          user: currentUser,
          text: escapeHtml(filteredText),
          timestamp: now,
          ip: userIP
        };
        
        // Determine which chat to post to
        const ref = isAdmin && window.location.hash === '#admin' ? 
          adminChatRef : messagesRef;
        
        ref.push(message);
        lastMessageTime = now;
        document.getElementById('messageInput').value = '';
      });
    }

    // Filter banned words
    function filterBannedWords(text) {
      return bannedWords.reduce((str, word) => 
        str.replace(new RegExp(word, 'gi'), '*'.repeat(word.length)), text);
    }

    // Setup user list
    function setupUserList() {
      usersRef.on('value', snapshot => {
        const users = snapshot.val() || {};
        const userList = document.getElementById('userList');
        userList.innerHTML = '';
        
        Object.entries(users).forEach(([username, data]) => {
          const userEl = document.createElement('div');
          userEl.className = 'user-item';
          userEl.innerHTML = `
            <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
            <span>${username}</span>
            ${data.isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
            ${!data.isAdmin && isAdmin ? 
              `<button class="btn-warning" onclick="reportUser('${username}')" style="margin-left: auto;">Report</button>` : ''}
          `;
          userList.appendChild(userEl);
        });
      });
    }

    // Load messages
    function loadMessages() {
      // Clear existing listeners
      messagesRef.off();
      adminChatRef.off();
      
      // Determine which chat to load
      const ref = window.location.hash === '#admin' ? adminChatRef : messagesRef;
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      
      ref.orderByChild('timestamp').limitToLast(100).on('child_added', snapshot => {
        const message = snapshot.val();
        message.id = snapshot.key;
        displayMessage(message);
      });
    }

    // Display message
    function displayMessage(message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      messageElement.dataset.id = message.id;
      
      const timeString = new Date(message.timestamp).toLocaleTimeString();
      
      messageElement.innerHTML = `
        <div class="message-header">
          <div class="user-avatar">${message.user.charAt(0).toUpperCase()}</div>
          <span class="username">${escapeHtml(message.user)}</span>
          <span class="timestamp">[${timeString}]</span>
          ${message.user !== currentUser ? 
            `<button class="btn-warning" onclick="reportMessage('${message.id}')" style="margin-left: auto;">Report</button>` : ''}
        </div>
        <div class="message-text">${message.text}</div>
        ${isAdmin ? `
          <div class="message-actions">
            <button onclick="deleteMessage('${message.id}')" class="btn-danger">Delete</button>
            <button onclick="banUserFromMessage('${escapeHtml(message.user)}')" class="btn-danger">Ban</button>
          </div>
        ` : ''}
      `;
      
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Delete message
    function deleteMessage(messageId) {
      if (!isAdmin) return;
      
      const ref = window.location.hash === '#admin' ? adminChatRef : messagesRef;
      ref.child(messageId).remove();
      
      // Log moderation action
      modLogsRef.push({
        action: 'delete',
        moderator: currentUser,
        target: messageId,
        timestamp: Date.now()
      });
    }

    // Delete all messages
    function deleteAllMessages() {
      if (!isAdmin) return;
      
      if (confirm("Are you sure you want to delete ALL messages?")) {
        const ref = window.location.hash === '#admin' ? adminChatRef : messagesRef;
        ref.remove();
        
        // Log moderation action
        modLogsRef.push({
          action: 'delete_all',
          moderator: currentUser,
          timestamp: Date.now()
        });
      }
    }

    // Ban user
    function banUser() {
      if (!isAdmin) return;
      
      const username = document.getElementById('banInput').value.trim();
      const hours = parseInt(document.getElementById('banDuration').value) || 0;
      const banUntil = hours > 0 ? Date.now() + (hours * 3600 * 1000) : Number.MAX_SAFE_INTEGER;
      
      if (username) {
        // Ban username
        bannedUsersRef.child(username).set(banUntil);
        
        // Try to ban by IP if we have it
        usersRef.child(username).once('value').then(snap => {
          const userData = snap.val();
          if (userData?.ip) {
            ipBansRef.child(userData.ip).set(banUntil);
          }
        });
        
        // Log moderation action
        modLogsRef.push({
          action: 'ban',
          moderator: currentUser,
          target: username,
          duration: hours,
          timestamp: Date.now()
        });
        
        alert(`${username} banned ${hours > 0 ? `for ${hours} hours` : 'permanently'}`);
        document.getElementById('banInput').value = '';
      }
    }

    // Ban user from message
    function banUserFromMessage(username) {
      if (!isAdmin) return;
      
      if (confirm(`Ban ${username}?`)) {
        const hours = parseInt(prompt("Ban duration in hours (0 for permanent):", "24")) || 0;
        const banUntil = hours > 0 ? Date.now() + (hours * 3600 * 1000) : Number.MAX_SAFE_INTEGER;
        
        bannedUsersRef.child(username).set(banUntil);
        
        // Try to ban by IP if we have it
        usersRef.child(username).once('value').then(snap => {
          const userData = snap.val();
          if (userData?.ip) {
            ipBansRef.child(userData.ip).set(banUntil);
          }
        });
        
        // Log moderation action
        modLogsRef.push({
          action: 'ban',
          moderator: currentUser,
          target: username,
          duration: hours,
          timestamp: Date.now()
        });
        
        alert(`${username} banned ${hours > 0 ? `for ${hours} hours` : 'permanently'}`);
      }
    }

    // Report user
    function reportUser(username) {
      if (!username || username === currentUser) return;
      
      const reason = prompt("Reason for reporting this user?");
      if (reason) {
        reportedMessagesRef.push({
          reporter: currentUser,
          reportedUser: username,
          reason: reason,
          timestamp: Date.now()
        });
        
        alert(`${username} has been reported`);
      }
    }

    // Report message
    function reportMessage(messageId) {
      const reason = prompt("Reason for reporting this message?");
      if (reason) {
        const ref = window.location.hash === '#admin' ? adminChatRef : messagesRef;
        ref.child(messageId).once('value').then(snap => {
          const message = snap.val();
          
          reportedMessagesRef.push({
            reporter: currentUser,
            reportedUser: message.user,
            messageId: messageId,
            messageText: message.text,
            reason: reason,
            timestamp: Date.now()
          });
          
          alert("Message reported");
        });
      }
    }

    // Load moderation logs
    function loadModLogs() {
      modLogsRef.orderByChild('timestamp').limitToLast(20).on('value', snapshot => {
        const logs = snapshot.val() || {};
        const modLogsEl = document.getElementById('modLogs');
        modLogsEl.innerHTML = '';
        
        Object.entries(logs).forEach(([id, log]) => {
          const logEl = document.createElement('div');
          logEl.style.marginBottom = '5px';
          logEl.textContent = `${new Date(log.timestamp).toLocaleString()} - 
                              ${log.moderator || log.reporter} ${log.action || 'reported'} 
                              ${log.target || log.reportedUser} 
                              ${log.duration ? `for ${log.duration}h` : ''}`;
          modLogsEl.appendChild(logEl);
        });
      });
    }

    // Switch to admin chat
    function switchToAdminChat() {
      window.location.hash = '#admin';
      loadMessages();
      alert("Switched to admin chat");
    }

    // Switch to public chat
    function switchToPublicChat() {
      window.location.hash = '';
      loadMessages();
      alert("Switched to public chat");
    }

    // Typing indicator functions
    let typingTimeout;
    function updateTypingIndicator(isTyping) {
      if (!currentUser) return;
      typingRef.child(currentUser).set(isTyping);
    }

    function debounceTypingIndicator() {
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        updateTypingIndicator(false);
      }, 2000);
    }

    function setupTypingListener() {
      typingRef.on('value', (snapshot) => {
        const typingUsers = snapshot.val() || {};
        const usersTyping = Object.keys(typingUsers)
          .filter(username => typingUsers[username] && username !== currentUser);
        
        const typingIndicator = document.getElementById('typingIndicator');
        if (usersTyping.length > 0) {
          typingIndicator.textContent = `${usersTyping.join(', ')} ${usersTyping.length > 1 ? 'are' : 'is'} typing...`;
        } else {
          typingIndicator.textContent = '';
        }
      });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Make functions available globally
    window.login = login;
    window.logout = logout;
    window.sendMessage = sendMessage;
    window.deleteMessage = deleteMessage;
    window.deleteAllMessages = deleteAllMessages;
    window.banUser = banUser;
    window.banUserFromMessage = banUserFromMessage;
    window.reportUser = reportUser;
    window.reportMessage = reportMessage;
    window.switchToAdminChat = switchToAdminChat;
    window.switchToPublicChat = switchToPublicChat;
  </script>
</body>
</html>
